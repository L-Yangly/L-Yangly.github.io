# 图像处理 0x 02：颜色空间

摘要：图像类型可分为二值图像、灰度图像、索引图像和RGB图像等，不同的图像类型对应不同的颜色空间，呈现的效果也大不相同。进一步基于不同颜色的特征，可以进行roi的提取，也可以利用颜色直方图匹配等等
<!--more-->

# 图像处理 0x 02：颜色空间

## 图像类型

### 1、二值图像

二维矩阵仅由0、255两个值构成，“0”代表黑色，“255”代白色。由于每一像素（矩阵中每一元素）取值仅有0、255两种可能，所以计算机中二值图像的数据类型通常为1个二进制位。二值图像通常用于文字、线条图的扫描识别（OCR）和掩膜图像的存储。

### 2、灰度图像

灰度图像矩阵元素的取值范围通常为[0，255]。数据类型为8位无符号整数（int8），即256灰度图像。“0”表示纯黑色，“255”表示纯白色，中间的数字从小到大表示由黑到白的过渡色。

### 3、索引图像（伪彩色图像）

索引图像的文件结构：二维图像矩阵(MxN)+颜色索引二维矩阵MAP(Kx3)

原理：二维图像矩阵存放图像的像素值大小”K”，MAP存放”K”映射的RGB颜色值，通过位置信息找到二维图像中的像素值，根据像素值大小去索引二维矩阵中搜索RGB的组合值。

应用：索引图像一般用于存放色彩要求比较简单的图像，如Windows中色彩构成比较简单的壁纸多采用索引图像存放，如果图像的色彩比较复杂，就要用到RGB真彩色图像。

优缺点：图像质量不高，它的数据信息包括一个数据矩阵和一个双精度色图矩阵，它的数据矩阵中的值直接指定该点的颜色为色图矩阵中的某一种，色图矩阵中，每一行表示一种颜色，每行有三个数据，分别表示该种颜色中红、绿、蓝的比例情况，所有元素值都在[0，1]内。占空间较少。通常用于网络上的图片传输、对图像像素、大小有严格要求的地方。

### 4、真彩色图像

彩色图像一般指RGB图像（MxNx3），RGB图像分别用红（R）、绿（G）、蓝（B）三原色的组合来表示每个像素的颜色。但与索引图像不同的是，RGB图像每一个像素的颜色值（RGB三原色表示）直接存放在图像矩阵中，最后一维表示RGB三种颜色的比例。

## 颜色空间

### 1、RGB颜色空间

RGB颜色空间：其原理是加色思想，三原色（红色R、绿色G和蓝色B）之间的线性组合，三者之间相互独立，每个颜色在各自通道可以在 0～255 之间取值，一共可以组成 255×255×255 种颜色。大自然中有很多颜色，不是所有的颜色人眼都能辨别出来，RGB 三个基色叠加的颜色是最接近人眼所看到的颜色，该空间具有直观容易理解等特点。

几何解释：以一个三维空间为例，x、y、z分布表示R、G、B三种颜色的数值，其空间中每一个点都相当于三种颜色组合叠加。若用RGB来理解色彩、深浅、明暗变化（**<strong style="color:red;">#todo: 不懂</strong>**）：

- 原点到白色顶点的中轴线是灰度线，r、g、b三分量相等，强度可以由三分量的向量表示。
- 色彩变化：三个坐标轴RGB最大分量顶点与黄紫青YMC色顶点的连线
- 深浅变化：RGB顶点和CMY顶点到原点和白色顶点的中轴线的距离
- 明暗变化：中轴线的点的位置，到原点，就偏暗，到白色顶点就偏亮


<div align=center>
    <img src=https://cloud-resources-data.oss-cn-chengdu.aliyuncs.com/blog/20190317110618326.png width=75% />
</div>

### 2、HSV颜色空间

HSV(Hue, Saturation, Value)是根据颜色的直观特性由A. R. Smith在1978年创建的一种颜色空间, 也称六角锥体模型(Hexcone Model),分别由色调（H），饱和度（S），亮度（V）组成。

- 色调（Hue）：**表示色彩信息，用角度度量**，取值范围为0°～360°，从红色开始按逆时针方向计算，红色为0°，绿色为120°,蓝色为240°。它们的补色是：黄色为60°，青色为180°,紫色为300°；
- 饱和度（Saturation）：**颜色接近光谱色（单色光、白光分解的赤橙黄绿青蓝紫）的程度**。一种颜色，可以看成是某种光谱色与白色混合的结果。其中光谱色所占的比例愈大，颜色接近光谱色的程度就愈高，颜色的饱和度也就愈高。饱和度高，颜色则深而艳。光谱色的白光成分为0，饱和度达到最高。通常取值范围为0%～100%，值越大，颜色越饱和。
- 亮度（V）：明度表示颜色明亮的程度，**对于光源色，明度值与发光体的光亮度有关**；对于物体色，此值和物体的透射比或反射比有关。通常取值范围为0%（黑）到100%（白）。
- 注意：实际操作中， HSV的值均归一化到[0,255]。

六角锥体模型：

- 色调表示锥体顶部的角度范围，从红色R、绿色G到蓝色B，360度逆时针旋转。
- 饱和度表示离圆心的距离，从0到1之间，1表示离光谱色最近，越饱和，颜色深而艳。
- 亮度表示离锥尖的距离，离锥尖越近，越黑，反之越白。注意：它和光强度之间并没有直接的联系。

<div align=center>
    <img src=https://cloud-resources-data.oss-cn-chengdu.aliyuncs.com/blog/8d5494eef01f3a29fb2420739925bc315d607c9b width=75% />
</div>



### 3、Lab 颜色空间

Lab 颜色空间中，L 表示亮度，a 和 b 表示色彩，L 的数值范围在\[0,100\]，数值越大代表亮度越高。a 的值在\[-128,+127\]之间，-128 表示颜色是纯绿色，+127 表示颜色是纯红色，数值从-128 到 127 代表绿色到红色的颜色过渡过程。b 的值也在\[-128,+127\]之间，-128 表示颜色为纯蓝色，+127 表示颜色为纯黄色，数值从-128 到 127 代表从蓝色到黄色的过渡过程\[61\]。Lab 表达的是人眼在视力正常下能看到的全部颜色，表现的色域比 RGB 颜色空间广阔。

<div align=center>
    <img src=https://cloud-resources-data.oss-cn-chengdu.aliyuncs.com/blog/640 width=75% />
</div>

## 颜色空间转换

### 1、RGB转灰度图像

常见的灰度图像：最大值灰度处理、平均灰度处理 和 加权平均灰度处理。
$$
\begin{aligned}
Gray &= max(R, G, B)  \\
	 &= (R + G + B)  /  3  \\
	 &= 0.299 * R + 0.587 * G + 0.114 * B
\end{aligned}
$$
运算过程：遍历RGB（uint8），浮点计算灰度值，转uint8。

效率优化：效率问题-> 浮点数运算转化为整数运算，整数运算转换为位操作。

1. 浮点数运算转整数运算。整数运算会截断小数部分，加上500是为了四舍五入，减少精度损失。

$$
Gray = (299*R + 587*G + 114*B + 500) / 1000
$$

2. 位运算：乘除2的幂。

$$
\begin{aligned}
Gray &= （1024*299*R+ 1024*587*G + 1024*114*B）÷（1024*1000）\\
	 &= （306176*R+601088*G + 116736*B）÷（1024*1000） \\
	 &= （306.176*R+601.088*G + 116.736*B）÷（1024）\\
	 &= （306*R+601*G + 116*B）÷（1024）\color{#F00} \text{ //整数截断误差 } \\
	 &= （306*R+601*G + 116*B） >> 10; \\
\end{aligned}
$$

误差问题:可能会导致1个灰度值的波动。
$$
\begin{aligned}
\frac{(306.176-306)*255 + (601.088-601)*255
+ (116.736-116)*255)}{1024} & = \frac{255}{1024} =0.249
\end{aligned}
$$
不同精度位运算的优化公式：
$$
\begin{aligned}
Gray &= (R*38 + G*75 + B*15) >> 7 \\
	 &= (R*76 + G*150 + B*30) >> 8 \\
	 &= (R*306 + G*601 + B*117) >> 10 \\
	 &= (R*19595 + G*38469 + B*7472) >> 16
\end{aligned}
$$

### 2、RGB转HSV
注意：在不同应用场景中，HSV取值范围是不尽相同的。（PS和Opencv）
RGB2HSV 转换公式：
$$
R' = R / 255 \\
G' = G / 255 \\
B' = B / 255 \\
max = max(R',G',B') \\
min = min(R',G',B') \\
$$
$$
	H=\left\{\begin{array}
{ll}0^{\circ}, & \text { if } \max =\min \\ 60^{\circ} \times \frac{G-B}{\max -\min }+0^{\circ}, & \text { if } \max =R \text { and } G \geq B \\ 60^{\circ} \times \frac{G-B}{\max -\min }+360^{\circ}, & \text { if } \max =R \text { and } G<B \\ 60^{\circ} \times \frac{G-B}{\max -\min }+120^{\circ}, & \text { if } \max =G \\ 60^{\circ} \times \frac{G-B}{\max -\min }+240^{\circ}, & \text { if } \max =B
\end{array}\right.
$$
$$
S = \left\{\begin{array}
{ll}0^{\circ}, & \text { if } \max =0 \\ \frac{\max -\min }{\max }=1-\frac{\min }{\max }, & \text { otherwise }
\end{array}\right.
$$

$$
V = max
$$
HSV2RGB 转换公式：

![img](https://bbsmax.ikafan.com/static/L3Byb3h5L2h0dHBzL2ltYWdlczIwMTUuY25ibG9ncy5jb20vYmxvZy83NTcyMDUvMjAxNzA0Lzc1NzIwNS0yMDE3MDQyOTExMzkyMDQxMi0xNDAyODM1ODM5LnBuZw==.jpg)



### 3、伪彩色图像转换

将灰度图像转换为彩色图像，称为灰度图像的伪彩色处理。伪彩色处理技术的实现方式有很多，如：灰度分割法、灰度级-彩色变换法、滤波法等等。

灰度级-彩色变换法：gray转RGB，gray转viridis

- 灰度级-彩色变换法，这是将来自传感器的灰度图像送入三个不同特征的R、G、B变换器，然后将三种变换器的不同输出分别送到彩色显示器进行显示的技术。
- gray转RGB映射关系，其中R(x,y)、G(x,y)、B(x,y)分别表示R、G、B通道的颜色值，f(x,y)表示特定点灰度图像的灰度值，f是所选灰度图像的灰度值。

$$
\begin{array}{c}
R(x, y)=\left\{\begin{array}{cc}
0 & 0 \leq f \leq 63 \\
0 & 64 \leq f \leq 127 \\
4 f(x, y)-510 & 128 \leq f \leq 191 \\
255 & 192 \leq f \leq 255
\end{array}\right. \\
G(x, y)=\left\{\begin{array}{cc}
254-4 f(x, y) & 0 \leq f \leq 63 \\
4 f(x, y)-254 & 64 \leq f \leq 127 \\
255 & 128 \leq f \leq 191 \\
1022-4 f(x, y) & 192 \leq f \leq 255
\end{array}\right. \\
B(x, y)=\left\{\begin{array}{rl}
255 & 0 \leq f \leq 63 \\
510-4 f(x, y) & 64 \leq f \leq 127 \\
0 & 128 \leq f \leq 191 \\
0 & 192 \leq f \leq 255
\end{array}\right.
\end{array}
$$


